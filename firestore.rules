rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function familyExists(fid) {
      return exists(/databases/$(db)/documents/families/$(fid));
    }

    function isOwner(fid) {
      return signedIn()
        && familyExists(fid)
        && get(/databases/$(db)/documents/families/$(fid)).data.ownerUid == request.auth.uid;
    }

    function isMember(fid) {
      return signedIn()
        && familyExists(fid)
        && (
          (get(/databases/$(db)/documents/families/$(fid)).data.members is map)
          && (request.auth.uid in get(/databases/$(db)/documents/families/$(fid)).data.members.keys())
        );
    }

    match /users/{uid} {
      allow read, create, update: if signedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    match /family_names/{nameLower} {
      allow get: if signedIn();
      allow list: if false;

      allow create: if signedIn()
        && !exists(/databases/$(db)/documents/family_names/$(nameLower))
        && request.resource.data.ownerUid == request.auth.uid;

      allow delete: if signedIn()
        && resource.data.ownerUid == request.auth.uid;

      allow update: if false;
    }

    match /families/{fid} {

      // Owner veya üye doc'u okuyabilir
      allow get: if isOwner(fid) || isMember(fid);
      allow list: if false;

      // Create: yalnızca kendi adını owner olarak yazarak
      allow create: if signedIn()
        && request.resource.data.ownerUid == request.auth.uid
        && (request.resource.data.members is map)
        && (request.resource.data.members[request.auth.uid] == 'owner')
        && (request.resource.data.nameLower is string)
        && exists(/databases/$(db)/documents/family_names/$(request.resource.data.nameLower))
        && get(/databases/$(db)/documents/family_names/$(request.resource.data.nameLower)).data.ownerUid == request.auth.uid;

      // Update:
      allow update: if
        // 1) Owner serbest
        isOwner(fid)
        ||
        // 2) JOIN: üye değilken sadece kendini ekleyebilsin (merge ile)
        (
          signedIn()
          && familyExists(fid)
          && !(request.auth.uid in (resource.data.members is map ? resource.data.members.keys() : []))
          && (request.resource.data.members is map)
          && (request.resource.data.members[request.auth.uid] in ['editor','viewer'])
          // sadece belirli alanlar değişsin
          && request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(['members','memberNames','updatedAt'])
        )
        ||
        // 3) Üye: güvenli alanlar
        (
          isMember(fid)
          && request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(['name','nameLower','members','memberNames','inviteCode','updatedAt','createdAt'])
        );

      // Delete: sadece owner
      allow delete: if isOwner(fid);

      // ---- Subcollections ----
      match /tasks/{tid} {
        allow read, create, update, delete: if isOwner(fid) || isMember(fid);
      }
      match /weekly/{docId} {
        allow read, create, update, delete: if isOwner(fid) || isMember(fid);
      }
      match /expenses/{eid} {
        allow read, create, update, delete: if isOwner(fid) || isMember(fid);
      }
      match /items/{iid} {
        allow read, create, update, delete: if isOwner(fid) || isMember(fid);
      }
      // diğer alt koleksiyonlar
      match /{sub=**}/{docId} {
        allow read, create, update, delete: if isOwner(fid) || isMember(fid);
      }
    }

    match /invites/{code} {
      allow get: if signedIn();
      allow list: if false;

      allow create: if signedIn()
        && request.resource.data.ownerUid == request.auth.uid;

      allow update, delete: if signedIn()
        && request.auth.uid == resource.data.ownerUid;
    }
  }
}